// Ïû†Ïàò Í≤åÏûÑ ÌîÑÎ°úÏ†ùÌä∏ JavaScript

class DivingGame {
    constructor() {
        this.gameArea = document.getElementById('game-area');
        this.diver = document.getElementById('diver');
        this.treasuresContainer = document.getElementById('treasures');
        this.obstaclesContainer = document.getElementById('obstacles');

        // Í≤åÏûÑ ÏÉÅÌÉú
        this.gameRunning = false;
        this.isPaused = false;
        this.score = 0;
        this.lives = 3;
        this.time = 60;

        // Îã§Ïù¥Î≤Ñ ÏÉÅÌÉú
        this.diverState = {
            x: 200,
            y: 100,
            vx: 0,
            vy: 0,
            width: 32,
            height: 32
        };

        // Î¨ºÎ¶¨ ÏÉÅÏàò
        this.gravity = 0.3;
        this.buoyancy = -0.15;
        this.waterResistance = 0.95;
        this.airResistance = 0.98;
        this.moveSpeed = 1.5;

        // Í≤åÏûÑ Í∞ùÏ≤¥Îì§
        this.treasures = [];
        this.obstacles = [];

        // ÌÇ§ ÏûÖÎ†• ÏÉÅÌÉú
        this.keys = {
            up: false,
            down: false,
            left: false,
            right: false,
            space: false
        };

        this.init();
    }

    init() {
        this.setupEventListeners();
        this.setupTabs();
        this.createObstacles();
        this.createTreasures();
        this.updateUI();
        this.handleHashNavigation();
    }

    setupEventListeners() {
        // Í≤åÏûÑ Ïª®Ìä∏Î°§ Î≤ÑÌäº
        document.getElementById('start-btn').addEventListener('click', () => {
            this.startGame();
        });

        document.getElementById('reset-btn').addEventListener('click', () => {
            this.resetGame();
        });

        // ÌÇ§Î≥¥Îìú ÏûÖÎ†•
        document.addEventListener('keydown', (e) => {
            this.handleKeyDown(e);
        });

        document.addEventListener('keyup', (e) => {
            this.handleKeyUp(e);
        });

        // Í≤åÏûÑ ÏòÅÏó≠ Ìè¨Ïª§Ïä§ (ÌÇ§Î≥¥Îìú ÏûÖÎ†•ÏùÑ ÏúÑÌï¥)
        this.gameArea.setAttribute('tabindex', '0');
        this.gameArea.focus();
    }

    handleKeyDown(e) {
        switch(e.code) {
            case 'ArrowUp':
                this.keys.up = true;
                e.preventDefault();
                break;
            case 'ArrowDown':
                this.keys.down = true;
                e.preventDefault();
                break;
            case 'ArrowLeft':
                this.keys.left = true;
                e.preventDefault();
                break;
            case 'ArrowRight':
                this.keys.right = true;
                e.preventDefault();
                break;
            case 'Space':
                this.keys.space = true;
                this.togglePause();
                e.preventDefault();
                break;
        }
    }

    handleKeyUp(e) {
        switch(e.code) {
            case 'ArrowUp':
                this.keys.up = false;
                break;
            case 'ArrowDown':
                this.keys.down = false;
                break;
            case 'ArrowLeft':
                this.keys.left = false;
                break;
            case 'ArrowRight':
                this.keys.right = false;
                break;
            case 'Space':
                this.keys.space = false;
                break;
        }
    }

    startGame() {
        if (this.gameRunning) return;

        this.gameRunning = true;
        this.isPaused = false;
        document.getElementById('game-message').classList.add('hidden');
        document.getElementById('start-btn').disabled = true;

        this.gameLoop = setInterval(() => {
            if (!this.isPaused) {
                this.update();
            }
        }, 16); // ÏïΩ 60 FPS

        this.timer = setInterval(() => {
            if (!this.isPaused && this.gameRunning) {
                this.time--;
                this.updateUI();
                if (this.time <= 0) {
                    this.gameOver('ÏãúÍ∞Ñ Ï¢ÖÎ£å!');
                }
            }
        }, 1000);
    }

    update() {
        this.updateDiverMovement();
        this.updatePhysics();
        this.checkCollisions();
        this.updateDiverPosition();
        this.updateUI();
    }

    updateDiverMovement() {
        // ÌÇ§ ÏûÖÎ†•Ïóê Îî∞Î•∏ Ïù¥Îèô
        if (this.keys.left) {
            this.diverState.vx -= this.moveSpeed;
        }
        if (this.keys.right) {
            this.diverState.vx += this.moveSpeed;
        }
        if (this.keys.up) {
            this.diverState.vy -= this.moveSpeed;
        }
        if (this.keys.down) {
            this.diverState.vy += this.moveSpeed;
        }
    }

    updatePhysics() {
        const gameAreaRect = this.gameArea.getBoundingClientRect();
        const surfaceLevel = 64; // ÏàòÎ©¥ ÎÜíÏù¥
        const bottomLevel = gameAreaRect.height - 64; // Ìï¥Ï†Ä ÎÜíÏù¥

        // Ï§ëÎ†•Í≥º Î∂ÄÎ†• Ï†ÅÏö©
        if (this.diverState.y < surfaceLevel) {
            // ÏàòÎ©¥ ÏúÑ - Ï§ëÎ†•Îßå Ï†ÅÏö©
            this.diverState.vy += this.gravity;
            this.diverState.vx *= this.airResistance;
            this.diverState.vy *= this.airResistance;
        } else {
            // Î¨º ÏÜç - Ï§ëÎ†•Í≥º Î∂ÄÎ†• Î™®Îëê Ï†ÅÏö©
            this.diverState.vy += this.gravity + this.buoyancy;
            this.diverState.vx *= this.waterResistance;
            this.diverState.vy *= this.waterResistance;
        }

        // ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
        this.diverState.x += this.diverState.vx;
        this.diverState.y += this.diverState.vy;

        // Í≤ΩÍ≥Ñ Í≤ÄÏÇ¨
        if (this.diverState.x < 0) {
            this.diverState.x = 0;
            this.diverState.vx = 0;
        }
        if (this.diverState.x > gameAreaRect.width - this.diverState.width) {
            this.diverState.x = gameAreaRect.width - this.diverState.width;
            this.diverState.vx = 0;
        }
        if (this.diverState.y < 0) {
            this.diverState.y = 0;
            this.diverState.vy = 0;
        }
        if (this.diverState.y > bottomLevel) {
            this.diverState.y = bottomLevel;
            this.diverState.vy = 0;
        }
    }

    updateDiverPosition() {
        this.diver.style.left = `${this.diverState.x}px`;
        this.diver.style.top = `${this.diverState.y}px`;

        // Îã§Ïù¥Î≤ÑÍ∞Ä Î¨º ÏÜçÏóê ÏûàÎäîÏßÄ ÌëúÏãú
        if (this.diverState.y > 64) {
            this.diver.style.filter = 'hue-rotate(180deg)';
        } else {
            this.diver.style.filter = 'none';
        }
    }

    createObstacles() {
        const gameAreaRect = this.gameArea.getBoundingClientRect();
        this.obstacles = [];

        // Î∞îÏúÑ Ïû•Ïï†Î¨ºÎì§ÏùÑ Î¨¥ÏûëÏúÑÎ°ú Î∞∞Ïπò
        for (let i = 0; i < 8; i++) {
            const obstacle = {
                x: Math.random() * (gameAreaRect.width - 40),
                y: 100 + Math.random() * (gameAreaRect.height - 200),
                width: 30,
                height: 30
            };

            this.obstacles.push(obstacle);

            const obstacleElement = document.createElement('div');
            obstacleElement.className = 'absolute w-8 h-8 bg-gray-600 rounded-lg flex items-center justify-center';
            obstacleElement.style.left = `${obstacle.x}px`;
            obstacleElement.style.top = `${obstacle.y}px`;
            obstacleElement.innerHTML = 'ü™®';
            this.obstaclesContainer.appendChild(obstacleElement);
        }
    }

    createTreasures() {
        this.treasures = [];
        this.spawnTreasure();
        this.spawnTreasure();
        this.spawnTreasure();
    }

    spawnTreasure() {
        if (this.treasures.length >= 5) return; // ÏµúÎåÄ 5Í∞ú

        const gameAreaRect = this.gameArea.getBoundingClientRect();
        const treasure = {
            x: Math.random() * (gameAreaRect.width - 30),
            y: 80 + Math.random() * (gameAreaRect.height - 160),
            width: 25,
            height: 25,
            value: 10
        };

        this.treasures.push(treasure);

        const treasureElement = document.createElement('div');
        treasureElement.className = 'absolute w-6 h-6 bg-yellow-400 rounded-full flex items-center justify-center animate-pulse';
        treasureElement.style.left = `${treasure.x}px`;
        treasureElement.style.top = `${treasure.y}px`;
        treasureElement.innerHTML = 'üí∞';
        this.treasuresContainer.appendChild(treasureElement);
    }

    checkCollisions() {
        const diverRect = {
            x: this.diverState.x,
            y: this.diverState.y,
            width: this.diverState.width,
            height: this.diverState.height
        };

        // Î≥¥Î¨º Ï∂©Îèå Í≤ÄÏÇ¨
        this.treasures.forEach((treasure, index) => {
            if (this.isColliding(diverRect, treasure)) {
                this.collectTreasure(index);
            }
        });

        // Ïû•Ïï†Î¨º Ï∂©Îèå Í≤ÄÏÇ¨
        this.obstacles.forEach(obstacle => {
            if (this.isColliding(diverRect, obstacle)) {
                this.hitObstacle();
            }
        });
    }

    isColliding(rect1, rect2) {
        return rect1.x < rect2.x + rect2.width &&
               rect1.x + rect1.width > rect2.x &&
               rect1.y < rect2.y + rect2.height &&
               rect1.y + rect1.height > rect2.y;
    }

    collectTreasure(index) {
        const treasure = this.treasures[index];
        this.score += treasure.value;

        // Î≥¥Î¨º Ï†úÍ±∞
        this.treasures.splice(index, 1);
        this.treasuresContainer.children[index].remove();

        // ÏÉà Î≥¥Î¨º ÏÉùÏÑ±
        setTimeout(() => {
            this.spawnTreasure();
        }, 1000);

        this.updateUI();
    }

    hitObstacle() {
        if (Date.now() - (this.lastHit || 0) < 1000) return; // 1Ï¥à Î¨¥Ï†ÅÏãúÍ∞Ñ

        this.lastHit = Date.now();
        this.lives--;
        this.updateUI();

        // Îã§Ïù¥Î≤ÑÎ•º ÏïàÏ†ÑÌïú ÏúÑÏπòÎ°ú Ïù¥Îèô
        this.diverState.x = 200;
        this.diverState.y = 100;
        this.diverState.vx = 0;
        this.diverState.vy = 0;

        if (this.lives <= 0) {
            this.gameOver('ÏÉùÎ™ÖÏù¥ Î™®Îëê ÏÜåÏßÑÎêòÏóàÏäµÎãàÎã§!');
        }
    }

    togglePause() {
        if (!this.gameRunning) return;

        this.isPaused = !this.isPaused;
        const message = document.getElementById('game-message');

        if (this.isPaused) {
            message.innerHTML = 'ÏùºÏãúÏ†ïÏßÄ<br><small>Ïä§ÌéòÏù¥Ïä§Î∞îÎ•º Îã§Ïãú ÎàÑÎ•¥Î©¥ Í≥ÑÏÜçÎê©ÎãàÎã§</small>';
            message.classList.remove('hidden');
        } else {
            message.classList.add('hidden');
        }
    }

    gameOver(reason) {
        this.gameRunning = false;
        this.isPaused = false;

        clearInterval(this.gameLoop);
        clearInterval(this.timer);

        const message = document.getElementById('game-message');
        message.innerHTML = `
            Í≤åÏûÑ Ï¢ÖÎ£å!<br>
            <div class="text-lg mt-4">${reason}</div>
            <div class="text-lg mt-2">ÏµúÏ¢Ö Ï†êÏàò: ${this.score}</div>
            <button class="bg-green-500 text-white px-4 py-2 rounded-lg mt-4" onclick="location.reload()">
                Îã§Ïãú ÏãúÏûë
            </button>
        `;
        message.classList.remove('hidden');

        document.getElementById('start-btn').disabled = false;
    }

    resetGame() {
        this.gameRunning = false;
        this.isPaused = false;
        this.score = 0;
        this.lives = 3;
        this.time = 60;

        this.diverState.x = 200;
        this.diverState.y = 100;
        this.diverState.vx = 0;
        this.diverState.vy = 0;

        // Í∏∞Ï°¥ Í≤åÏûÑ Î£®ÌîÑ Ï†ïÎ¶¨
        if (this.gameLoop) clearInterval(this.gameLoop);
        if (this.timer) clearInterval(this.timer);

        // Î≥¥Î¨ºÍ≥º Ïû•Ïï†Î¨º Ïû¨ÏÉùÏÑ±
        this.treasuresContainer.innerHTML = '';
        this.obstaclesContainer.innerHTML = '';
        this.createObstacles();
        this.createTreasures();

        this.updateUI();
        this.updateDiverPosition();

        document.getElementById('game-message').innerHTML = 'Í≤åÏûÑÏùÑ ÏãúÏûëÌïòÎ†§Î©¥ ÏãúÏûë Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî!';
        document.getElementById('game-message').classList.remove('hidden');
        document.getElementById('start-btn').disabled = false;
    }

    updateUI() {
        document.getElementById('score').textContent = this.score;
        document.getElementById('lives').textContent = this.lives;
        document.getElementById('time').textContent = this.time;
    }

    // ÌÉ≠ ÏãúÏä§ÌÖú
    setupTabs() {
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tab = e.target.dataset.tab;
                this.showTab(tab);
            });
        });

        document.querySelectorAll('.code-tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const lang = e.target.dataset.lang;
                this.showCodeTab(lang);
            });
        });
    }

    showTab(activeTab) {
        document.querySelectorAll('.tab-btn').forEach(btn => {
            if (btn.dataset.tab === activeTab) {
                btn.classList.add('active', 'text-blue-600', 'border-blue-600');
                btn.classList.remove('text-gray-600');
            } else {
                btn.classList.remove('active', 'text-blue-600', 'border-blue-600');
                btn.classList.add('text-gray-600');
            }
        });

        document.querySelectorAll('.tab-content').forEach(content => {
            if (content.id === `${activeTab}-tab`) {
                content.classList.remove('hidden');
                content.classList.add('active');
            } else {
                content.classList.add('hidden');
                content.classList.remove('active');
            }
        });
    }

    showCodeTab(activeLang) {
        document.querySelectorAll('.code-tab-btn').forEach(btn => {
            if (btn.dataset.lang === activeLang) {
                btn.classList.add('active', 'text-green-600', 'border-green-600');
                btn.classList.remove('text-gray-600');
            } else {
                btn.classList.remove('active', 'text-green-600', 'border-green-600');
                btn.classList.add('text-gray-600');
            }
        });

        document.querySelectorAll('.code-content').forEach(content => {
            if (content.id === `${activeLang}-code`) {
                content.classList.remove('hidden');
                content.classList.add('active');
            } else {
                content.classList.add('hidden');
                content.classList.remove('active');
            }
        });
    }

    handleHashNavigation() {
        const hash = window.location.hash.substring(1);
        if (hash === 'run' || hash === 'demo') {
            this.showTab('demo');
        } else if (hash === 'source') {
            this.showTab('source');
        } else if (hash === 'tutorial') {
            this.showTab('tutorial');
        }
    }
}

// ÌÖúÌîåÎ¶ø Îã§Ïö¥Î°úÎìú Ìï®Ïàò
function downloadDivingGameTemplate() {
    alert('Ïû†Ïàò Í≤åÏûÑ ÌÖúÌîåÎ¶øÏùÑ Îã§Ïö¥Î°úÎìúÌï©ÎãàÎã§!\n\nÌè¨Ìï®Îêú ÎÇ¥Ïö©:\n‚Ä¢ Îã§Ïù¥Î≤Ñ Ïä§ÌîÑÎùºÏù¥Ìä∏\n‚Ä¢ Î∞∞Í≤Ω Î∞è ÌôòÍ≤Ω ÏÑ§Ï†ï\n‚Ä¢ Í∏∞Î≥∏ Î¨ºÎ¶¨ ÏãúÏä§ÌÖú\n‚Ä¢ Î≥¥Î¨º Î∞è Ïû•Ïï†Î¨º ÏòàÏ†ú\n‚Ä¢ Í≤åÏûÑ UI ÌÖúÌîåÎ¶ø');

    // Ïã§Ï†ú ÌååÏùº Îã§Ïö¥Î°úÎìú ÏãúÎÆ¨Î†àÏù¥ÏÖò
    const link = document.createElement('a');
    link.href = 'samples/diving_game_template.sb3';
    link.download = 'diving_game_template.sb3';
    link.click();
}

// ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
document.addEventListener('DOMContentLoaded', () => {
    new DivingGame();
});

// Ìï¥Ïãú Î≥ÄÍ≤Ω Í∞êÏßÄ
window.addEventListener('hashchange', () => {
    const game = new DivingGame();
    game.handleHashNavigation();
});